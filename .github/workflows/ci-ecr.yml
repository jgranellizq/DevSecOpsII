
name: Manual CI to ECR (Build, Tests, SonarCloud, Trivy, ECR Push)

on:
  workflow_dispatch:  # Solo manual

env:
  AWS_REGION: eu-west-3
  ECR_REPOSITORY: hipo-registry

jobs:
  manual-ci-ecr:
    runs-on: ubuntu-latest

    steps:
      # -------------------------
      # Bloque 1 – Build & Test
      # -------------------------
      - name: Checkout del código
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configurar Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      # ---- Tests + Coverage (JaCoCo) ----
      - name: Build + Tests con cobertura
        run: mvn -B -ntp clean verify

      # -------------------------
      # Bloque 2 – Calidad (SonarCloud)
      # -------------------------
      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v7
        with:
          projectBaseDir: .
          # Si prefieres, pasa args o usa sonar-project.properties
          # args: >
          #   -Dsonar.organization=tu-org
          #   -Dsonar.projectKey=tu-projectKey
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Check Quality Gate
        uses: SonarSource/sonarqube-quality-gate-action@v1
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      # -------------------------
      # Bloque 3 – Seguridad (Trivy)
      # -------------------------
      - name: Escaneo de seguridad con Trivy (FS)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: fs
          severity: CRITICAL,HIGH
          # exit-code: 1  # Activa si quieres fallar ante vulnerabilidades

      # -------------------------
      # Bloque 4 – Publicación en Amazon ECR
      # -------------------------
      - name: Configurar credenciales de AWS
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login a Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Etiquetas: latest + SHA
      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}
          tags: |
            type=raw,value=latest
            type=sha

      - name: Build y Push a ECR
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
